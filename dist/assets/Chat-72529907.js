var ns=Object.defineProperty;var as=(t,a,d)=>a in t?ns(t,a,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[a]=d;var Te=(t,a,d)=>(as(t,typeof a!="symbol"?a+"":a,d),d);import{M as os,d as xt,r as v,o as St,W as g,a as bt,w as rs,c as ht,C as q,b as m,e as p,f as o,t as L,g as D,h as Ae,n as _e,i as Pe,v as Re,F as Y,j as oe,k as et,l as te,A as ge,m as vt,p as me,q as ls,s as De,u as Je,x as pe,y as cs,z as ft,B as is,D as Ze,E as ve,G as ke,T as He,H as Xe,I as Ye,P as gt,J as Z,S as mt,K as fe,L as us,N as ds,O as hs}from"./index-da0dfb42.js";import{g as O}from"./index-c3bfaefd.js";class We{constructor(a){Te(this,"conversation");Te(this,"avatarHashTag");this.conversation=a}get channel(){return this.conversation.channel}get channelInfo(){return this.conversation.channelInfo}get unread(){return this.conversation.unread}get timestamp(){return this.conversation.timestamp}set timestamp(a){this.conversation.timestamp=a}get timestampString(){return vs(this.timestamp*1e3,!0)}get lastMessage(){return this.conversation.lastMessage}set lastMessage(a){this.conversation.lastMessage=a}get isMentionMe(){return this.conversation.isMentionMe}get remoteExtra(){return this.conversation.remoteExtra}set isMentionMe(a){this.conversation.isMentionMe=a}get reminders(){return this.conversation.reminders}get simpleReminders(){return this.conversation.simpleReminders}reloadIsMentionMe(){return this.conversation.reloadIsMentionMe()}get extra(){return this.conversation.extra||(this.conversation.extra={}),this.conversation.extra}isEqual(a){return this.conversation.isEqual(a.conversation)}}function vs(t,a){var d=new Date,f=new Date(t),E=d.getFullYear(),w=d.getMonth()+1,V=d.getDate(),P=f.getFullYear(),W=f.getMonth()+1,M=f.getDate(),U="",R=a?" "+qe(f,"hh:mm"):"";if(E===P){var Ce=d.getTime(),F=t,N=Ce-F;if(w===W&&V===M)N<60*1e3?U="刚刚":U=qe(f,"hh:mm");else{var T=new Date;T.setDate(T.getDate()-1);var I=new Date;if(I.setDate(I.getDate()-2),W===T.getMonth()+1&&M===T.getDate())U="昨天"+R;else if(W===I.getMonth()+1&&M===I.getDate())U="前天"+R;else{var se=N/36e5;if(se<=7*24){var j=new Array(7);j[0]="星期日",j[1]="星期一",j[2]="星期二",j[3]="星期三",j[4]="星期四",j[5]="星期五",j[6]="星期六";var ae=j[f.getDay()];U=ae+R}else U=qe(f,"yyyy/M/d")+R}}}else U=qe(f,"yyyy/M/d")+R;return U}var qe=function(t,a){var d={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(t.getFullYear()+"").substr(4-RegExp.$1.length)));for(var f in d)new RegExp("("+f+")").test(a)&&(a=a.replace(RegExp.$1,RegExp.$1.length===1?d[f]:("00"+d[f]).substr((""+d[f]).length)));return a};class Ue extends os{constructor(d="",f=[]){super();Te(this,"text","");Te(this,"atUsers",[]);this.text=d,this.atUsers=f,this.contentType=10}decodeJSON(d){this.text=d.text||"",this.atUsers=d.at_users||[]}encodeJSON(){return{text:this.text,at_users:this.atUsers}}get conversationDigest(){return this.text}}const fs={class:"avatar"},gs=["src"],ms={key:0,class:"user-info"},ps={class:"username"},_s=o("div",{class:"status"},null,-1),ys=o("i",{class:"fas fa-chevron-left"},null,-1),ws=[ys],Cs={key:0,class:"lsearch-box"},xs={class:"conversation-list"},Ss=["onClick"],bs={class:"item-content"},Ms={class:"avatar"},Is={key:0,class:"group-avatar"},Ts=["src"],Ds=["src"],ks={key:0,class:"info"},As={class:"title-row"},Us={class:"title"},Ns={class:"time"},Es={class:"message-row"},Os={class:"last-message"},$s={key:0,class:"at-badge"},Ls={key:0,class:"unread-badge"},Bs=xt({__name:"index",props:{onSelectChannel:{type:Function},userName:{},isCollapse:{type:Boolean},selectedChannel:{}},emits:["logout","update:isCollapse","editName"],setup(t,{emit:a}){const d=t,f=v(),E=v(),w=v({}),V=v({}),P=v(""),W=v(""),M=v({}),U={cache:new Map,pendingRequests:new Map,batchQueue:new Set,batchTimeout:null,EXPIRE_TIME:5*60*1e3,getCached(r){const i=this.cache.get(r);return i&&Date.now()-i.timestamp<this.EXPIRE_TIME?i.data:null},addToBatch(r){return this.batchQueue.add(r),this.batchTimeout&&clearTimeout(this.batchTimeout),this.batchTimeout=setTimeout(()=>{this.executeBatch()},50),new Promise(i=>{const l=this.pendingRequests.get(r);if(l)return l.then(i);const h=new Promise(y=>i(null));return this.pendingRequests.set(r,h),h})},addBatchNoWait(r){r.forEach(i=>this.batchQueue.add(i)),this.batchTimeout&&clearTimeout(this.batchTimeout),this.batchTimeout=setTimeout(()=>{this.executeBatch()},50)},async executeBatch(){if(this.batchQueue.size===0)return;const r=Array.from(this.batchQueue);this.batchQueue.clear();const i=r.filter(l=>!this.getCached(l));if(i.length!==0){console.log("uncachedAccounts",i);try{const h=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/get`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accounts:i})})).json();h.success&&h.data&&Object.entries(h.data).forEach(([y,C])=>{const x=C;this.cache.set(y,{data:x,timestamp:Date.now()}),w.value[y]=x.name,V.value[y]=x.avatar??"",y===d.userName&&(P.value=x.name,W.value=x.avatar??""),this.pendingRequests.get(y)&&this.pendingRequests.delete(y)})}catch(l){console.error("批量获取用户信息失败:",l)}}}},R={cache:new Map,async fetchGroupNames(r){try{const l=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/setting`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:r})})).json();l.success&&l.data&&l.data.forEach(h=>{M.value[h.code]=h.group,this.cache.set(h.code,{name:h.name,timestamp:Date.now()})})}catch(i){console.error("获取群组名称失败:",i)}}},Ce=r=>V.value[r];v([]);const F=v(""),N=v(!1),T=v({}),I=async r=>{if(console.log("!!!!!!同步最近会话列表",r),r===et.Connected&&!N.value){N.value=!0;const i=await g.shared().conversationManager.sync();if(console.log("remoteConversations",i),i&&i.length>0){const h=i.filter(x=>x.channel.channelType===te||x.channel.channelType===q),y=new Set,C=new Set;h.forEach(x=>{x.channel.channelType===te?y.add(x.channel.channelID):x.channel.channelType===q&&C.add(x.channel.channelID)}),console.log("groupIds",C),y.size>0&&U.addBatchNoWait(Array.from(y)),C.size>0&&R.fetchGroupNames(Array.from(C)),f.value=K(h.map(x=>new We(x)))}await new Promise(h=>setTimeout(h,500));let l=localStorage.getItem("role");if(console.log("role",l),l==="0"){F.value=g.shared().config.uid||"";let h=localStorage.getItem("robot")||"",y=new me(h,te);await ge.shared.joinChannel(h,te,F.value);let C=g.shared().conversationManager.findConversation(y);if(C||(C=g.shared().conversationManager.createEmptyConversation(y)),console.log("conversation_robot",C),h&&(()=>{if(!C||!C.lastMessage)return!0;try{const $=C.lastMessage.content;if($&&"contentObj"in $){const G=$.contentObj;if(G&&G.welcome_sent===!0&&G.type===1)return!1}}catch($){console.error("解析最后一条消息失败:",$)}const k=C.lastMessage.timestamp,b=Math.floor(Date.now()/1e3)-5*60;return k<b})()){const k={content:"您好！我是您的智能客服助手，请问有什么可以帮助您",type:1,welcome_sent:!0},b=vt.Buffer.from(JSON.stringify(k)).toString("base64");await fetch(`${O().HOST}/site/imapi?s=/message/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({header:{no_persist:0,red_dot:1,sync_once:0},from_uid:h,channel_id:F.value,channel_type:te,payload:b})})}re(y);let S=localStorage.getItem("groupcode")||"";if(S){let k=new me(S,q);await ge.shared.joinChannel(S,q,g.shared().config.uid||""),g.shared().conversationManager.findConversation(k)||g.shared().conversationManager.createEmptyConversation(k)}}else if(l==="1"||l==="2"){if(l==="1"&&localStorage.getItem("scope")==""){alert("当前客服账号没有设置供应商，请联系管理员设置");return}try{const y=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/setting`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:"",supcust_no:l==="1"?localStorage.getItem("scope"):""})})).json();if(console.log("result",y),y.success&&y.data)for(const C of y.data){let x=new me(C.code,q);if(!g.shared().conversationManager.findConversation(x)){console.log("创建空会话",C.code),await ge.shared.joinChannel(C.code,q,g.shared().config.uid||""),g.shared().conversationManager.createEmptyConversation(x);const k={content:`大家好，我是${w.value[g.shared().config.uid||""]||g.shared().config.uid}`,type:1};try{const b=vt.Buffer.from(JSON.stringify(k)).toString("base64");await fetch(`${O().HOST}/site/imapi?s=/message/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({header:{no_persist:0,red_dot:1,sync_once:0},from_uid:g.shared().config.uid,channel_id:C.code,channel_type:q,payload:b})})}catch(b){console.error("发送欢迎消息失败:",b)}}}}catch(h){console.error("获取群组设置失败:",h)}}}},se=r=>{const i=r.content;if(i.cmd===ls.CMDTypeClearUnread){const l=new me(i.param.channelID,i.param.channelType);ae(l)}},j=async(r,i)=>{var l,h,y,C,x;if(console.log("会话监听:",i,r),i===De.add||i===De.update){const S=r.channel;S.channelType===te?w.value[S.channelID]||U.addBatchNoWait([S.channelID]):S.channelType===q&&(M.value[S.channelID]||await R.fetchGroupNames([S.channelID]));const k=`${S.channelID}-${S.channelType}`;if((l=E.value)!=null&&l.isEqual(r.channel))r.unread=0,T.value[k]&&(T.value[k]={hasAt:!1,messageIds:[]},localStorage.setItem("atMessageStatus",JSON.stringify(T.value)));else if(((h=r.lastMessage)==null?void 0:h.content)instanceof Ue&&r.lastMessage.content.atUsers.some(G=>G.uid===d.userName)){(!T.value[k]||typeof T.value[k]!="object")&&(T.value[k]={hasAt:!1,messageIds:[]});const G=T.value[k];G.messageIds.includes(r.lastMessage.messageID)||(G.hasAt=!0,G.messageIds.push(r.lastMessage.messageID),localStorage.setItem("atMessageStatus",JSON.stringify(T.value)))}if(i===De.add)f.value=[new We(r),...((y=f.value)==null?void 0:y.filter(b=>!b.channel.isEqual(r.channel)))||[]];else{const b=(C=f.value)==null?void 0:C.findIndex($=>$.channel.isEqual(r.channel));if(b!==void 0&&b>=0){const $=[...f.value||[]];$[b]=new We(r),f.value=K($)}}}else i===De.remove&&(f.value=((x=f.value)==null?void 0:x.filter(S=>!S.channel.isEqual(r.channel)))||[])},ae=r=>{const i=g.shared().conversationManager.findConversation(r);i&&(i.unread=0,g.shared().conversationManager.notifyConversationListeners(i,De.update))};St(async()=>{var l;if(console.log("!!!!list:monted"),g.shared().connectManager.addConnectStatusListener(I),g.shared().conversationManager.addConversationListener(j),g.shared().chatManager.addCMDListener(se),d.userName){const h=await U.addToBatch(d.userName);h&&(P.value=h.name)}(l=d.selectedChannel)!=null&&l.channelID&&U.addBatchNoWait([d.selectedChannel.channelID]);const r=h=>{P.value=h.detail.name,h.detail.avatar&&(W.value=h.detail.avatar)};document.addEventListener("userNameUpdated",r),document.addEventListener("userNameUpdated",h=>{const y=localStorage.getItem("username");y&&w.value&&(w.value[y]=h.detail.name)});const i=localStorage.getItem("atMessageStatus");i&&(T.value=JSON.parse(i))}),bt(()=>{N.value=!1,f.value=[],console.log("!!!!list:unmonted"),g.shared().connectManager.removeConnectStatusListener(I),g.shared().conversationManager.removeConversationListener(j),g.shared().chatManager.removeCMDListener(se),document.removeEventListener("userNameUpdated",r=>{const i=localStorage.getItem("username");i&&w.value&&(w.value[i]=r.detail.name)})});const K=r=>{let i=r;return i||(i=f.value),!i||i.length<=0?[]:i.sort((h,y)=>{var S,k;let C=h.timestamp,x=y.timestamp;return((S=h.extra)==null?void 0:S.top)===1&&(C+=1e12),((k=y.extra)==null?void 0:k.top)===1&&(x+=1e12),x-C})},re=async r=>{let i="";r.channelType===q?i=(M.value[r.channelID]||r.channelID)+"(群)":i=w.value[r.channelID]||r.channelID,E.value=r;const l=g.shared().conversationManager.findConversation(r);if(l){const y=`${r.channelID}-${r.channelType}`;l.unread=0,T.value[y]&&(T.value[y]={hasAt:!1,messageIds:[]},localStorage.setItem("atMessageStatus",JSON.stringify(T.value)))}g.shared().channelManager.getChannelInfo(r)||await g.shared().channelManager.fetchChannelInfo(r),d.onSelectChannel(r,i),await ge.shared.clearUnread(r)},le=r=>{g.shared().channelManager.getChannelInfo(r)||g.shared().channelManager.fetchChannelInfo(r)};rs(()=>d.selectedChannel,r=>{if(r){E.value=r;const i=g.shared().conversationManager.findConversation(r);i&&(i.unread=0)}},{immediate:!0});const Ee=()=>{d.isCollapse||a("editName")},ce=v(["http://kefu.coolsaas.com.cn:8093/static/img/avatar/99.png"]),ze=r=>{if(xe.value[r])return xe.value[r];const i=(C,x)=>{let S=0;for(let k=0;k<C.length;k++)S=(S<<5)-S+C.charCodeAt(k),S=S&S;return S=Math.abs(S),S%x+1},l=new Set,h=i(r,20);for(;l.size<4;){const C=(h+l.size)%20+1;l.add(C)}const y=Array.from(l).map(C=>`http://kefu.coolsaas.com.cn:8093/static/img/avatar/${C}.png`);return xe.value[r]=y,y},xe=v({}),ee=v(""),Ve=ht(()=>!ee.value||!f.value?f.value:f.value.filter(r=>{const i=r.channel.channelID,l=ee.value.toLowerCase();return r.channel.channelType===q?(M.value[i]||i).toLowerCase().includes(l):(w.value[i]||i).toLowerCase().includes(l)})),Ke=ht(()=>f.value&&f.value.length>10),Se=r=>{if(!r)return!1;const i=`${r.channel.channelID}-${r.channel.channelType}`,l=T.value[i];return l&&typeof l=="object"&&"hasAt"in l?l.hasAt&&r.unread>0:!1};return(r,i)=>(m(),p("div",{class:_e(["conversations",{show:!d.isCollapse}])},[o("div",{class:_e(["user-card",{collapsed:d.isCollapse}]),onClick:Ee},[o("div",fs,[o("img",{src:W.value||ce.value[0]},null,8,gs)]),d.isCollapse?D("",!0):(m(),p("div",ms,[o("div",ps,L(P.value||d.userName),1),_s])),o("div",{class:"collapse-icon",onClick:i[0]||(i[0]=Ae(l=>r.$emit("update:isCollapse",!0),["stop"]))},ws)],2),!d.isCollapse&&Ke.value?(m(),p("div",Cs,[Pe(o("input",{type:"text","onUpdate:modelValue":i[1]||(i[1]=l=>ee.value=l),placeholder:"搜索",class:"lsearch-input"},null,512),[[Re,ee.value]])])):D("",!0),o("div",xs,[(m(!0),p(Y,null,oe(Ve.value,l=>{var h,y,C;return m(),p("div",{class:_e(["conversation-item",{selected:(h=E.value)==null?void 0:h.isEqual(l.channel),"at-message":Se(l)}]),onClick:x=>re(l.channel)},[Je(L(le(l.channel))+" ",1),o("div",bs,[o("div",Ms,[l.channel.channelType===pe(q)?(m(),p("div",Is,[(m(!0),p(Y,null,oe(ze(l.channel.channelID),(x,S)=>(m(),p(Y,{key:S},[S<4?(m(),p("img",{key:0,src:x},null,8,Ts)):D("",!0)],64))),128))])):(m(),p("img",{key:1,src:Ce(l.channel.channelID)||ce.value[0]},null,8,Ds))]),d.isCollapse?D("",!0):(m(),p("div",ks,[o("div",As,[o("span",Us,L(l.channel.channelType===pe(q)?(M.value[l.channel.channelID]||l.channel.channelID)+"(群)":w.value[l.channel.channelID]||l.channel.channelID),1),o("span",Ns,L(l.timestampString),1)]),o("div",Es,[o("span",Os,[Se(l)?(m(),p("span",$s,"有人@我")):D("",!0),Je(" "+L((y=l.lastMessage)==null?void 0:y.content.conversationDigest),1)]),l.unread>0&&!((C=E.value)!=null&&C.isEqual(l.channel))?(m(),p("span",Ls,L(l.unread),1)):D("",!0)])]))])],10,Ss)}),256))])],2))}});const Mt="3.7.7",Hs=Mt,we=typeof Buffer=="function",pt=typeof TextDecoder=="function"?new TextDecoder:void 0,_t=typeof TextEncoder=="function"?new TextEncoder:void 0,qs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Ne=Array.prototype.slice.call(qs),je=(t=>{let a={};return t.forEach((d,f)=>a[d]=f),a})(Ne),js=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,B=String.fromCharCode.bind(String),yt=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),It=t=>t.replace(/=/g,"").replace(/[+\/]/g,a=>a=="+"?"-":"_"),Tt=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),Dt=t=>{let a,d,f,E,w="";const V=t.length%3;for(let P=0;P<t.length;){if((d=t.charCodeAt(P++))>255||(f=t.charCodeAt(P++))>255||(E=t.charCodeAt(P++))>255)throw new TypeError("invalid character found");a=d<<16|f<<8|E,w+=Ne[a>>18&63]+Ne[a>>12&63]+Ne[a>>6&63]+Ne[a&63]}return V?w.slice(0,V-3)+"===".substring(V):w},nt=typeof btoa=="function"?t=>btoa(t):we?t=>Buffer.from(t,"binary").toString("base64"):Dt,tt=we?t=>Buffer.from(t).toString("base64"):t=>{let d=[];for(let f=0,E=t.length;f<E;f+=4096)d.push(B.apply(null,t.subarray(f,f+4096)));return nt(d.join(""))},Fe=(t,a=!1)=>a?It(tt(t)):tt(t),Ps=t=>{if(t.length<2){var a=t.charCodeAt(0);return a<128?t:a<2048?B(192|a>>>6)+B(128|a&63):B(224|a>>>12&15)+B(128|a>>>6&63)+B(128|a&63)}else{var a=65536+(t.charCodeAt(0)-55296)*1024+(t.charCodeAt(1)-56320);return B(240|a>>>18&7)+B(128|a>>>12&63)+B(128|a>>>6&63)+B(128|a&63)}},Rs=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,kt=t=>t.replace(Rs,Ps),wt=we?t=>Buffer.from(t,"utf8").toString("base64"):_t?t=>tt(_t.encode(t)):t=>nt(kt(t)),ye=(t,a=!1)=>a?It(wt(t)):wt(t),Ct=t=>ye(t,!0),Fs=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Js=t=>{switch(t.length){case 4:var a=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),d=a-65536;return B((d>>>10)+55296)+B((d&1023)+56320);case 3:return B((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return B((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},At=t=>t.replace(Fs,Js),Ut=t=>{if(t=t.replace(/\s+/g,""),!js.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let a,d="",f,E;for(let w=0;w<t.length;)a=je[t.charAt(w++)]<<18|je[t.charAt(w++)]<<12|(f=je[t.charAt(w++)])<<6|(E=je[t.charAt(w++)]),d+=f===64?B(a>>16&255):E===64?B(a>>16&255,a>>8&255):B(a>>16&255,a>>8&255,a&255);return d},at=typeof atob=="function"?t=>atob(Tt(t)):we?t=>Buffer.from(t,"base64").toString("binary"):Ut,Nt=we?t=>yt(Buffer.from(t,"base64")):t=>yt(at(t).split("").map(a=>a.charCodeAt(0))),Et=t=>Nt(Ot(t)),zs=we?t=>Buffer.from(t,"base64").toString("utf8"):pt?t=>pt.decode(Nt(t)):t=>At(at(t)),Ot=t=>Tt(t.replace(/[-_]/g,a=>a=="-"?"+":"/")),st=t=>zs(Ot(t)),Vs=t=>{if(typeof t!="string")return!1;const a=t.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(a)||!/[^\s0-9a-zA-Z\-_]/.test(a)},$t=t=>({value:t,enumerable:!1,writable:!0,configurable:!0}),Lt=function(){const t=(a,d)=>Object.defineProperty(String.prototype,a,$t(d));t("fromBase64",function(){return st(this)}),t("toBase64",function(a){return ye(this,a)}),t("toBase64URI",function(){return ye(this,!0)}),t("toBase64URL",function(){return ye(this,!0)}),t("toUint8Array",function(){return Et(this)})},Bt=function(){const t=(a,d)=>Object.defineProperty(Uint8Array.prototype,a,$t(d));t("toBase64",function(a){return Fe(this,a)}),t("toBase64URI",function(){return Fe(this,!0)}),t("toBase64URL",function(){return Fe(this,!0)})},Ks=()=>{Lt(),Bt()},Gs={version:Mt,VERSION:Hs,atob:at,atobPolyfill:Ut,btoa:nt,btoaPolyfill:Dt,fromBase64:st,toBase64:ye,encode:ye,encodeURI:Ct,encodeURL:Ct,utob:kt,btou:At,decode:st,isValid:Vs,fromUint8Array:Fe,toUint8Array:Et,extendString:Lt,extendUint8Array:Bt,extendBuiltins:Ks},Qs=["show"],Zs={class:"answer_popup__content"},Xs=["innerHTML"],Ys={class:"chat"},Ws={class:"content"},en={class:"bottom"},tn=["innerHTML"],sn={key:0},nn={class:"message-box"},an={class:"header"},on={class:"left"},rn=["innerHTML"],ln={class:"title"},cn=["id"],un={key:0,class:"status"},dn={class:"bubble right bagright"},hn=["innerHTML"],vn={key:1,class:"text"},fn=["onClick"],gn={key:2,class:"text"},mn={class:"avatar"},pn=["src"],_n=["id"],yn={class:"sender-name"},wn={class:"avatar"},Cn=["src"],xn={class:"bubble"},Sn=["innerHTML"],bn={key:1,class:"text"},Mn=["onClick"],In={key:2,class:"text"},Tn=["onClick"],Dn={key:0},kn=["onClick"],An={class:"footer"},Un={class:"input-wrapper"},Nn={key:0,class:"at-panel"},En=["onClick"],On=["src"],$n=["placeholder","onKeydown"],Ln={class:"action-buttons"},Bn={class:"action-btn"},Hn=["innerHTML"],qn=["innerHTML"],jn={key:0,class:"setting"},Pn={class:"box-center"},Rn={class:"box-center"},Fn=["src"],Jn={key:0,class:"setting"},zn=o("h3",null,"确认退出",-1),Vn=o("p",null,"您确定要退出登录吗？",-1),Kn={key:0,class:"setting"},Gn={class:"setting-content edit-profile-dialog"},Qn=o("h3",null,"修改个人信息",-1),Zn={class:"avatar-selector"},Xn={class:"current-avatar"},Yn=["src"],Wn={class:"avatar-list"},ea=["onClick"],ta=["src","alt"],sa={class:"input-group"},na=o("label",null,"名称：",-1),aa=["onKeyup"],oa={key:0,class:"setting"},ra={class:"setting-content problem-dialog"},la=o("h3",null,"提交问题",-1),ca={class:"input-group"},ia={class:"button-group"},va=xt({__name:"Chat",setup(t){const a=cs(),d=v(null),f=v(!1),E=v(""),w=v("");let V=0;const P=v(""),W=v(!0);localStorage.getItem("robot");const M=v(new me("",1));v("请输入对方登录名");const U=v(!1),R=v(!1);v(!1);const Ce=v("请输入消息"),F=v(),N=v(new Array);let T=localStorage.getItem("username");T==null&&(T=""),T==null&&(T=""),console.log("uid__________",T,localStorage.getItem("username")),T==""&&a.push({path:"/login"});const I=v(T);localStorage.getItem("password"),E.value=`${T||""}(离线)`;let se,j,ae;const K=v(!1),re=v(""),le=new Map,Ee=async s=>{if(!s)return null;if(le.has(s))return le.get(s);if(H.value[s])return{name:H.value[s],avatar:z.value[s],account:s};const e=(async()=>{try{const u=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/get`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accounts:[s]})})).json();if(u.success&&u.data&&u.data[s]){const n=u.data[s];return H.value[s]=n.name,z.value[s]=n.avatar||Oe(s),n}}catch(c){console.error("获取客服信息失败:",c)}finally{le.delete(s)}return null})();return le.set(s,e),e},ce=()=>{Vt()};St(async()=>{const s=new URLSearchParams(window.location.hash.split("?")[1]),e=s.get("uid"),c=s.get("token"),u=s.get("channelID");e&&c&&(localStorage.setItem("username",e),localStorage.setItem("password",c),I.value=e);const n=O();ge.shared.config.apiURL=`${n.HOST}/site/imapi?s=/`;let _=`${n.WS_HOST}`;if(xe(_),console.log(M.value),ze(),u){await new Promise(ss=>{const dt=()=>{g.shared().connectManager.status===et.Connected?ss(!0):setTimeout(dt,100)};dt()});const ne=new me(u,te);await ge.shared.joinChannel(u,te,I.value);const he=await Ee(u),ts=he?he.name:u;Se(ne,ts)}document.addEventListener("previewImage",ne=>{ct(ne.detail)}),document.removeEventListener("createGroupChat",ce),document.addEventListener("createGroupChat",ce),localStorage.getItem("needUpdateName")==="true"&&(localStorage.removeItem("needUpdateName"),it());const X=10;g.shared().register(X,()=>new Ue),await Qe()});const ze=async()=>{},xe=s=>{g.shared().config.uid=I.value,g.shared().config.addr=s,se=e=>{e==et.Connected?(E.value=g.shared().config.uid+"(在线)",P.value=M.value.channelID):E.value=g.shared().config.uid+"(离线)"},g.shared().connectManager.addConnectStatusListener(se),j=e=>{if(M.value.isEqual(e.channel)){if(H.value[e.fromUID]||Ee(e.fromUID).then(c=>{c?(H.value[e.fromUID]=c.name,c.avatar?z.value[e.fromUID]=c.avatar:z.value[e.fromUID]=Oe(e.fromUID)):(H.value[e.fromUID]=e.fromUID,z.value[e.fromUID]=Oe(e.fromUID))}),e.streamOn){let c=!1;for(const u of N.value)if(u.streamNo===e.streamNo){let n=u.streams;const _=new us;_.clientMsgNo=e.clientMsgNo,_.streamSeq=e.streamSeq||0,_.content=e.content,n&&n.length>0?n.push(_):n=[_],u.streams=n,c=!0;break}c||N.value.push(e)}else N.value.push(e);ee()}},g.shared().chatManager.addMessageListener(j),ae=e=>{console.log("消息状态更新:",e);const c=N.value.findIndex(u=>u.clientSeq===e.clientSeq);if(c!==-1){const u=N.value[c];u.status=e.reasonCode===1?Xe.Normal:Xe.Fail,N.value=[...N.value]}},g.shared().chatManager.addMessageStatusListener(ae),g.shared().connect()};bt(()=>{g.shared().connectManager.removeConnectStatusListener(se),g.shared().chatManager.removeMessageListener(j),g.shared().chatManager.removeMessageStatusListener(ae),g.shared().disconnect(),document.removeEventListener("previewImage",s=>{ct(s.detail)}),document.removeEventListener("createGroupChat",ce)});const ee=()=>{Ye(()=>{const s=d.value;s&&(s.scrollTop=s.scrollHeight,requestAnimationFrame(()=>{s.scrollTop=s.scrollHeight}))})},Ve=async()=>{U.value=!0,R.value=!1;try{const s=await g.shared().chatManager.syncMessages(M.value,{limit:15,startMessageSeq:0,endMessageSeq:0,pullMode:gt.Up});if(s&&s.length>0){const e=new Set;s.forEach(u=>e.add(u.fromUID));const c=Array.from(e).filter(u=>!H.value[u]);if(c.length>0)try{const n=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/get`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accounts:c})})).json();n.success&&n.data&&Object.entries(n.data).forEach(([_,A])=>{const X=A;H.value[_]=X.name,z.value[_]=X.avatar||Oe(_)})}catch(u){console.error("获取用户信息失败:",u)}N.value.push(...s)}}catch(s){console.error("加载消息失败:",s)}finally{U.value=!1,ee()}},Ke=async()=>{if(N.value.length==0)return;const s=N.value[0];if(s.messageSeq==1){R.value=!0;return}try{const e=await g.shared().chatManager.syncMessages(M.value,{limit:15,startMessageSeq:s.messageSeq-1,endMessageSeq:0,pullMode:gt.Down});if(e&&e.length>0){const c=new Set(e.map(n=>n.fromUID)),u=Array.from(c).map(n=>Kt.addToBatch(n));await Promise.all(u),N.value.unshift(...e.reverse())}e.length<15&&(R.value=!0)}catch(e){console.error("加载历史消息失败:",e)}Ye(()=>{const e=d.value,c=document.getElementById(s.clientMsgNo);e&&c&&(e.scrollTop=c.offsetTop)})},Se=async(s,e)=>{M.value=s,P.value=s.channelID,W.value=s.channelType==te,f.value=!1,N.value=[],re.value=e,window.innerWidth<=640&&(K.value=!0),de.value=[],Ie.value=!1,s.channelType===q&&await Qe(s.channelID),Ve()},r=()=>{if(M.value.channelID===""){Z.warning("请先选择会话对象");return}if(!w.value||w.value.trim()===""){Z.warning("请输入信息内容");return}const s=mt.fromUint8(0);if(M.value&&M.value.channelID!=""){let e;if(M.value.channelType===q){const u=w.value.match(/@(\S+?)\s/g);if(u){const n=u.map(_=>{const A=_.slice(1).trim(),X=de.value.find(he=>he.name===A);if(X)return{uid:X.account,name:X.name};const ne=de.value.find(he=>he.account===A);return ne?{uid:ne.account,name:ne.name||ne.account}:null}).filter(_=>_!==null);n.length>0?e=new Ue(w.value,n):e=new fe(w.value)}else e=new fe(w.value)}else e=new fe(w.value);F.value&&F.value!==""&&(s.streamNo=F.value),g.shared().chatManager.send(e,M.value,s),w.value="";const c=document.querySelector(".message-input");c&&(c.style.height="40px")}else f.value=!0;ee()},i=s=>{(!w.value||w.value.trim()==="")&&(V++,w.value=`${V}`);const e=mt.fromUint8(0);if(M.value&&M.value.channelID!=""){F.value&&F.value!==""&&(e.streamNo=F.value);const c=new ds;if(s==""){const u=O();c.url=`${u.HOST}/qam/img/20240507/1715051818527950.jpg`}else c.url=s;c.width=window.innerWidth*.9,g.shared().chatManager.send(c,M.value)}else f.value=!0;ee()},l=s=>{if(s instanceof hs){if(s.content instanceof Ue){const u=s.content;let n=u.text;return u.atUsers.forEach(_=>{const A=new RegExp(`@${_.name}\\s`,"g");n=n.replace(A,`<span class="at-mention">@${_.name}</span> `)}),n}const e=s.streams;let c="";if(s.content instanceof fe){if(c=s.content.text||"",c==="没有关的答案？可点击我联系人工客服")return`<div class="customer-service-msg" onclick="document.dispatchEvent(new CustomEvent('createGroupChat'))">没有相关的答案,可点击我提交您的问题,稍后客服回复您。</div>`;if(s.content.contentObj!=null&&s.content.contentObj.is_json==!0)try{return JSON.parse(c)}catch{return c}}if(e&&e.length>0){for(const u of e)if(u.content instanceof fe){const n=u.content;c=c+(n.text||"")}}return s.contentType==2&&(c=`<img style='cursor: pointer;' src='${s.content.url}' onclick="document.dispatchEvent(new CustomEvent('previewImage', {detail: '${s.content.url}'}))">`),c}return"未知消息"},h=s=>{if(s.content instanceof Ue)return 1;if(s.content instanceof fe){const e=s.content;if(s.content.contentObj!=null){if(s.content.contentObj.qa!=null)return 3;if(s.content.contentObj.is_json==!0)try{let c=e.text||"";return JSON.parse(c),2}catch{return 1}}return 1}return 1},y=s=>{if(s.target.scrollTop<=250){if(U.value||R.value){console.log("不允许下拉","pulldowning",U.value,"pulldownFinished",R.value);return}console.log("下拉"),U.value=!0,Ke().then(()=>{U.value=!1}).catch(()=>{U.value=!1})}},C=()=>{r()},x=v(!1),S=v(""),k=(s,e)=>{x.value=!0,S.value=s},b=v({q:"",from_uid:"",clientMsgNo:"",reply:"",fromUID:""}),$=v(!1),G=s=>{$.value=!$.value,b.value.clientMsgNo=s.clientMsgNo,b.value.from_uid=l(s).from_uid,b.value.q=l(s).q,b.value.reply=b.value.q,b.value.fromUID=s.fromUID,console.log(b.value)},ot=s=>{if(s==0){Ge();return}var e=new Headers;let c=JSON.stringify({content:b.value.q,type:1});var u=JSON.stringify({reply:b.value.reply,content:b.value.q,payload:Gs.encode(c),from_uid:b.value.fromUID,kf:I.value,channel_id:b.value.from_uid,clientMsgNo:b.value.clientMsgNo,channel_type:1}),n={method:"POST",headers:e,body:u,redirect:"follow"};const _=O();fetch(`${_.HOST}/site/imapi?s=/message/send`,n).then(A=>A.text()).then(A=>console.log(A)).catch(A=>console.log("error",A)),console.log(b.value.q,b.value.from_uid),$.value=!$.value};function Ge(){x.value=!1,$.value=!1}let Ht=1;const qt={wordCount:!0,maximumWords:9999,autoHeightEnabled:!1,initialFrameHeight:440,initialFrameWidth:"100%",serverUrl:`${O().UPLOAD_SERVER}/controller.php`,UEDITOR_HOME_URL:"UEditor/",readonly:!1,focus:!0},jt=v(!0);document.body.clientWidth<=640&&(jt.value=!1);const rt=()=>{K.value=!K.value},Oe=s=>`${O().HOST}/site/get-img?name=${s}`,lt=v([]),Pt=(s,e)=>{if(s.response!=null){let c=JSON.parse(JSON.stringify(s.response));const u=O();i(`${u.UPLOAD_SERVER}${c.url}`)}},$e=v(""),ct=s=>{$e.value=s,document.body.style.overflow="hidden"},Rt=()=>{$e.value="",document.body.style.overflow=""},Le=v(!1),Ft=()=>{Le.value=!0},Jt=()=>{localStorage.setItem("username",""),g.shared().connectManager.disconnect(),a.push({path:"/login"}),Le.value=!1},zt=()=>{Le.value=!1},Vt=async()=>{Me.value=!0},H=v({}),Kt={cache:new Map,pendingRequests:new Map,batchQueue:new Set,batchTimeout:null,EXPIRE_TIME:5*60*1e3,getCached(s){const e=this.cache.get(s);return e&&Date.now()-e.timestamp<this.EXPIRE_TIME?e.data:null},addToBatch(s){return this.batchQueue.add(s),this.batchTimeout&&clearTimeout(this.batchTimeout),this.batchTimeout=setTimeout(()=>{this.executeBatch()},50),new Promise(e=>{const c=this.pendingRequests.get(s);if(c)return c.then(e);const u=new Promise(n=>e(null));return this.pendingRequests.set(s,u),u})},async executeBatch(){if(this.batchQueue.size===0)return;const s=Array.from(this.batchQueue);this.batchQueue.clear();try{const c=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/get`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accounts:s})})).json();c.success&&c.data&&Object.entries(c.data).forEach(([u,n])=>{const _=n;this.cache.set(u,{data:_,timestamp:Date.now()}),this.pendingRequests.get(u)&&this.pendingRequests.delete(u),H.value[u]=_.name})}catch(e){console.error("批量获取用户息失败:",e)}}},be=v(!1),J=v(""),it=async()=>{try{H.value[I.value]&&(J.value=H.value[I.value]);const e=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/get`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accounts:[I.value]})})).json();if(e.success&&e.data&&e.data[I.value]){const c=e.data[I.value];J.value=c.name,Q.value=c.avatar||ie.value[0],H.value[I.value]=c.name,z.value[I.value]=c.avatar||ie.value[0]}else J.value=I.value,Q.value=ie.value[0];be.value=!0}catch(s){console.error("获取用户信息失败:",s),J.value=I.value,Q.value=ie.value[0],be.value=!0}},Q=v(""),ie=v(["http://kefu.coolsaas.com.cn:8093/static/img/avatar/98.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/1.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/5.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/9.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/10.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/11.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/12.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/13.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/14.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/15.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/16.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/17.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/18.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/19.png","http://kefu.coolsaas.com.cn:8093/static/img/avatar/4.png"]),Gt=s=>{Q.value=s},ut=async()=>{if(!J.value.trim()){Z.error("请输入您的名字");return}try{const e=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({account:I.value,name:J.value.trim(),avatar:Q.value})})).json();e.success?(H.value[I.value]=J.value.trim(),z.value[I.value]=Q.value,be.value=!1,J.value=H.value[I.value]||I.value,Q.value=z.value[I.value],document.dispatchEvent(new CustomEvent("userNameUpdated",{detail:{name:J.value.trim(),avatar:Q.value}})),Z({message:"保存成功！",type:"success"})):Z.error(e.message||"保存失败")}catch(s){console.error("更新用户信息时发生错误:",s),Z.error("保存失败，请检查网络连接")}},Qt=()=>{if(!(H.value[I.value]||J.value.trim())){Z({message:"请设置您的名字，方便客服回复！",type:"warning"});return}be.value=!1,Q.value=""},z=v({}),Be={bars:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg>',paperPlane:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>',image:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6h336c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z"/></svg>',rightFromBracket:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/></svg>',plus:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>',logout:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/></svg>'},Me=v(!1),ue=v({messageId:"",problem:"",description:""}),Zt=s=>{ue.value={messageId:s,problem:"",description:""},Me.value=!0},Xt=async()=>{if(!ue.value.description.trim()){Z({message:"请输入问题描述",type:"warning"});return}try{const s=localStorage.getItem("robot")||"",e=localStorage.getItem("scope")||"";console.log(s,e);const u=await(await fetch(`${O().HOST}/site/add-unsolved-ques`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ques:ue.value.description.trim(),uid:I.value,robot:s,scope:e,kf:""})})).json();u.success?(Me.value=!1,ue.value.description="",Z({message:"问题已提交，我们会尽快处理！",type:"success"})):Z({message:u.message||"提交失败，请稍后重试",type:"error"})}catch(s){console.error("提交问题报告失败:",s),Z({message:"提交失败，请检查网络连接",type:"error"})}},de=v([]),Ie=v(!1),Qe=async s=>{localStorage.getItem("scope");try{const c=await(await fetch(`${O().HOST}/site/imapi?s=/kefu/list`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:s||""})})).json();console.log(c),c.success&&c.data&&(de.value=c.data.filter(u=>u.account!==I.value))}catch(e){console.error("获取客服列表失败:",e)}},Yt=s=>{const e=s.target;e.style.height="auto",e.style.height=`${Math.min(e.scrollHeight,120)}px`},Wt=s=>{Yt(s);const e=s.target,c=e.value,u=e.selectionStart||0,n=c.substring(0,u);M.value.channelType===q&&(n.endsWith("@")?(Ie.value=!0,de.value.length===0&&Qe(M.value.channelID)):n.lastIndexOf("@")===-1&&(Ie.value=!1))},es=s=>{const e=document.querySelector(".message-input");if(!e)return;const c=e.selectionStart||0,u=w.value.substring(0,c),n=w.value.substring(c),_=u.lastIndexOf("@");_!==-1&&(w.value=u.substring(0,_)+`@${s} `+n,Ye(()=>{const A=_+s.length+2;e.setSelectionRange(A,A),e.focus()})),Ie.value=!1};return(s,e)=>{const c=ft("el-upload"),u=ft("vue-ueditor-wrap");return m(),p(Y,null,[x.value?(m(),p("view",{key:0,class:"pop_box",onClick:Ge},[o("div",{round:10,mode:"top",closeOnClickOverlay:!0,closeable:!0,show:x.value,onClose:Ge},[o("view",Zs,[o("div",{class:"answer",innerHTML:S.value,onClick:e[0]||(e[0]=Ae(()=>{},["stop"]))},null,8,Xs)])],40,Qs)])):D("",!0),o("div",Ys,[o("div",Ws,[K.value?D("",!0):(m(),p("div",{key:0,class:"mobile-mask",onClick:rt})),o("div",{class:_e(["conversation-box",{collapsed:K.value}])},[(m(),is(Bs,{key:pe(Ht),onSelectChannel:Se,userName:I.value,selectedChannel:M.value,isCollapse:K.value,"onUpdate:isCollapse":e[1]||(e[1]=n=>K.value=n),onEditName:it},null,8,["userName","selectedChannel","isCollapse"])),o("div",en,[o("button",{onClick:Ft},[o("span",{class:"icon",innerHTML:Be.logout},null,8,tn),K.value?D("",!0):(m(),p("span",sn,"退出登录"))])])],2),o("div",nn,[o("div",an,[o("div",on,[o("button",{class:"menu-btn",onClick:rt},[o("span",{class:"icon",innerHTML:Be.bars},null,8,rn)]),o("div",ln,L(M.value.channelID.length==0?"选择联系人":(M.value.channelType==pe(q),re.value||M.value.channelID)),1)])]),o("div",{class:"message-list",onScroll:y,ref_key:"chatRef",ref:d},[(m(!0),p(Y,null,oe(N.value,n=>(m(),p(Y,null,[n.send?(m(),p("div",{key:0,class:"message right",id:n.clientMsgNo},[n.status!=pe(Xe).Normal?(m(),p("div",un,"发送中")):D("",!0),o("div",dn,[h(n)==1?(m(),p("div",{key:0,class:"text",innerHTML:l(n)},null,8,hn)):D("",!0),h(n)==2?(m(),p("div",vn,[(m(!0),p(Y,null,oe(l(n),(_,A)=>(m(),p("div",null,[o("a",{href:"javaScript:void(0);",onClick:X=>k(_.content,_.keyword)},L(A+1)+":"+L(_.keyword),9,fn)]))),256))])):D("",!0),h(n)==3?(m(),p("div",gn,[o("div",null,L(l(n).q),1)])):D("",!0)]),o("div",mn,[o("img",{src:z.value[n.fromUID]},null,8,pn)])],8,cn)):D("",!0),n.send?D("",!0):(m(),p("div",{key:1,class:"message left",id:n.clientMsgNo},[o("div",yn,L(H.value[n.fromUID]||n.fromUID),1),o("div",wn,[o("img",{src:z.value[n.fromUID]},null,8,Cn)]),o("div",xn,[h(n)==1?(m(),p("div",{key:0,class:"text",innerHTML:l(n)},null,8,Sn)):D("",!0),h(n)==2?(m(),p("div",bn,[(m(!0),p(Y,null,oe(l(n),(_,A)=>(m(),p("div",null,[o("a",{href:"javaScript:void(0);",onClick:X=>k(_.content,_.keyword)},L(A+1)+":"+L(_.keyword),9,Mn)]))),256))])):D("",!0),h(n)==3?(m(),p("div",In,[o("div",null,[Je(L(l(n).from_uid)+",提问："+L(l(n).q)+",未匹配到答案 ",1),o("a",{class:_e(n.remoteExtra.extra==""?"t-red":""),href:"javascript:void(0);",onClick:_=>G(n)},"回",10,Tn),n.remoteExtra.extra!=""?(m(),p("text",Dn,"("+L(n.remoteExtra.extra.kf)+"已回复"+L(n.remoteExtra.extra.id)+")",1)):D("",!0)])])):D("",!0)]),h(n)==2?(m(),p("div",{key:0,class:"unsolved-btn",onClick:_=>Zt(n.clientMsgNo)}," 未解决? ",8,kn)):D("",!0)],8,_n))],64))),256))],544),o("div",An,[o("div",Un,[Ie.value?(m(),p("div",Nn,[(m(!0),p(Y,null,oe(de.value,n=>(m(),p("div",{class:"at-item",key:n.account,onClick:_=>es(n.name||n.account)},[o("img",{src:z.value[n.account]||ie.value[0],class:"at-avatar"},null,8,On),o("span",null,L(n.name||n.account),1)],8,En))),128))])):D("",!0),Pe(o("textarea",{placeholder:Ce.value,"onUpdate:modelValue":e[2]||(e[2]=n=>w.value=n),class:"message-input",onKeydown:Ze(Ae(C,["prevent"]),["enter"]),onInput:Wt,rows:"1"},null,40,$n),[[Re,w.value]]),o("div",Ln,[ve(c,{"file-list":lt.value,"onUpdate:fileList":e[3]||(e[3]=n=>lt.value=n),class:"upload-demo",name:"upfile","show-file-list":!1,action:`${pe(O)().UPLOAD_SERVER}/controller.php?action=uploadimage`,"on-change":Pt},{default:ke(()=>[o("button",Bn,[o("span",{class:"icon",innerHTML:Be.image},null,8,Hn)])]),_:1},8,["file-list","action"]),o("button",{class:"action-btn send-btn",onClick:r},[o("span",{class:"icon",innerHTML:Be.paperPlane},null,8,qn),Je(" 发送 ")])])])])])])]),ve(He,{name:"fade"},{default:ke(()=>[$.value?(m(),p("div",jn,[o("div",{class:"setting-content",onClick:e[7]||(e[7]=Ae(()=>{},["stop"]))},[ve(u,{config:qt,modelValue:b.value.q,"onUpdate:modelValue":e[4]||(e[4]=n=>b.value.q=n),onKeydown:Ze(C,["enter"])},null,8,["modelValue","onKeydown"]),o("view",Pn,[o("button",{class:"ok",onClick:e[5]||(e[5]=n=>ot(0))},"取消")]),o("view",Rn,[o("button",{class:"ok",onClick:e[6]||(e[6]=n=>ot(1))},"确定")])])])):D("",!0)]),_:1}),$e.value?(m(),p("div",{key:1,class:"image-preview",onClick:Rt},[o("img",{src:$e.value,onClick:e[8]||(e[8]=Ae(()=>{},["stop"]))},null,8,Fn)])):D("",!0),ve(He,{name:"fade"},{default:ke(()=>[Le.value?(m(),p("div",Jn,[o("div",{class:"setting-content logout-confirm"},[zn,Vn,o("div",{class:"logout-buttons"},[o("button",{class:"cancel-btn",onClick:zt},"取消"),o("button",{class:"confirm-btn",onClick:Jt},"确定")])])])):D("",!0)]),_:1}),ve(He,{name:"fade"},{default:ke(()=>[be.value?(m(),p("div",Kn,[o("div",Gn,[Qn,o("div",Zn,[o("div",Xn,[o("img",{src:Q.value,alt:"当前头像"},null,8,Yn)]),o("div",Wn,[(m(!0),p(Y,null,oe(ie.value,(n,_)=>(m(),p("div",{key:_,class:_e(["avatar-option",{selected:Q.value===n}]),onClick:A=>Gt(n)},[o("img",{src:n,alt:`头像${_+1}`},null,8,ta)],10,ea))),128))])]),o("div",sa,[na,Pe(o("input",{type:"text","onUpdate:modelValue":e[9]||(e[9]=n=>J.value=n),placeholder:"输入你的名字方便客服回复哦！",onKeyup:Ze(ut,["enter"])},null,40,aa),[[Re,J.value]])]),o("div",{class:"button-group"},[o("button",{class:"cancel-btn",onClick:Qt},"取消"),o("button",{class:"confirm-btn",onClick:ut},"保存")])])])):D("",!0)]),_:1}),ve(He,{name:"fade"},{default:ke(()=>[Me.value?(m(),p("div",oa,[o("div",ra,[la,o("div",ca,[Pe(o("textarea",{"onUpdate:modelValue":e[10]||(e[10]=n=>ue.value.description=n),placeholder:"请详细描述您遇到的问题，请留意信息稍后客服回复您。",rows:"4"},null,512),[[Re,ue.value.description]])]),o("div",ia,[o("button",{class:"cancel-btn",onClick:e[11]||(e[11]=n=>Me.value=!1)},"取消"),o("button",{class:"confirm-btn",onClick:Xt},"提交")])])])):D("",!0)]),_:1})],64)}}});export{va as default};
